"use strict";
/**
 * File operations utilities for NSE API
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getPath = getPath;
exports.unzipFile = unzipFile;
exports.saveStreamToFile = saveStreamToFile;
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const util_1 = require("util");
const zlib_1 = __importDefault(require("zlib"));
const stream_1 = require("stream");
const adm_zip_1 = __importDefault(require("adm-zip"));
const pipeline = (0, util_1.promisify)(stream_1.pipeline);
/**
 * Resolve and validate file/folder path
 */
function getPath(p, isFolder = false) {
    const resolved = path_1.default.resolve(p);
    if (isFolder) {
        try {
            const stat = fs_1.default.existsSync(resolved) ? fs_1.default.statSync(resolved) : undefined;
            if (stat && stat.isFile()) {
                throw new Error(`${resolved}: must be a folder`);
            }
            if (!stat) {
                fs_1.default.mkdirSync(resolved, { recursive: true });
            }
        }
        catch (e) {
            throw e;
        }
    }
    return resolved;
}
/**
 * Extract zip or gzip files
 */
async function unzipFile(filePath, folder, extractFiles) {
    const ext = path_1.default.extname(filePath).toLowerCase();
    if (ext === ".zip") {
        const zip = new adm_zip_1.default(filePath);
        if (extractFiles && extractFiles.length > 0) {
            zip.extractEntryTo(extractFiles[extractFiles.length - 1], folder, false, true);
            const out = path_1.default.join(folder, extractFiles[extractFiles.length - 1]);
            fs_1.default.rmSync(filePath, { force: true });
            return out;
        }
        else {
            const entries = zip.getEntries();
            if (!entries.length) {
                throw new Error("Zip is empty");
            }
            const first = entries[0].entryName;
            zip.extractAllTo(folder, true);
            const out = path_1.default.join(folder, first);
            fs_1.default.rmSync(filePath, { force: true });
            return out;
        }
    }
    else if (ext === ".gz") {
        const dest = path_1.default.join(path_1.default.dirname(filePath), path_1.default.basename(filePath, ".gz"));
        const gzip = zlib_1.default.createGunzip();
        await pipeline(fs_1.default.createReadStream(filePath), gzip, fs_1.default.createWriteStream(dest));
        fs_1.default.rmSync(filePath, { force: true });
        return dest;
    }
    else {
        throw new Error("Unknown file format");
    }
}
/**
 * Save file from stream
 */
async function saveStreamToFile(stream, filePath) {
    await pipeline(stream, fs_1.default.createWriteStream(filePath));
}
//# sourceMappingURL=file-operations.js.map